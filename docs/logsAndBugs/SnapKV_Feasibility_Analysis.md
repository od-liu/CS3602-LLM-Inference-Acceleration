# SnapKV åœ¨ Pythia-70M ä¸Šçš„å¯è¡Œæ€§åˆ†æ

## 1. SnapKV ç®—æ³•æ ¸å¿ƒåŸç†

### 1.1 ç®—æ³•æµç¨‹

SnapKV æ˜¯ä¸€ä¸ª**æ— éœ€å¾®è°ƒ**çš„ KV Cache å‹ç¼©æ–¹æ³•ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

1. **è§‚å¯Ÿçª—å£ï¼ˆObservation Windowï¼‰**ï¼šä½¿ç”¨ prompt æœ«å°¾çš„ `window_size` ä¸ª token ä½œä¸ºè§‚å¯Ÿçª—å£
2. **æ³¨æ„åŠ›æƒé‡è®¡ç®—**ï¼šè®¡ç®—è§‚å¯Ÿçª—å£çš„ queries ä¸æ•´ä¸ª prompt çš„ keys çš„æ³¨æ„åŠ›æƒé‡
3. **ç‰¹å¾èšåˆ**ï¼šå¯¹æ³¨æ„åŠ›æƒé‡æ±‚å’Œï¼Œå¾—åˆ°æ¯ä¸ªä½ç½®çš„é‡è¦æ€§åˆ†æ•°
4. **æ± åŒ–èšç±»**ï¼šä½¿ç”¨ 1D æ± åŒ–ï¼ˆavgpool/maxpoolï¼‰å¯¹é‡è¦æ€§åˆ†æ•°è¿›è¡Œå¹³æ»‘ï¼Œé¿å…ç¨€ç–é€‰æ‹©
5. **Top-K é€‰æ‹©**ï¼šé€‰æ‹©æœ€é‡è¦çš„ `max_capacity_prompt - window_size` ä¸ªä½ç½®
6. **KV å‹ç¼©**ï¼šä¿ç•™é€‰ä¸­çš„ keys/valuesï¼Œä¸¢å¼ƒå…¶ä½™éƒ¨åˆ†

### 1.2 å…³é”®å‚æ•°

```python
window_size = 32-64          # è§‚å¯Ÿçª—å£å¤§å°
max_capacity_prompt = 256-2048  # å‹ç¼©åçš„æœ€å¤§ KV cache å¤§å°
kernel_size = 5-13           # æ± åŒ–æ ¸å¤§å°
pooling = 'avgpool'/'maxpool' # æ± åŒ–æ–¹æ³•
```

### 1.3 è®¡ç®—å¼€é”€åˆ†æ

**æ¯æ¬¡å‹ç¼©çš„è®¡ç®—æ­¥éª¤**ï¼ˆåœ¨ `update_kv` å‡½æ•°ä¸­ï¼‰ï¼š

1. **æ³¨æ„åŠ›æƒé‡è®¡ç®—**ï¼š
   ```python
   attn_weights = Q[-window_size:] @ K.T / sqrt(head_dim)
   ```
   - è®¡ç®—é‡ï¼š`O(window_size Ã— seq_len Ã— head_dim)`
   - å¯¹äº Pythia-70Mï¼šå‡è®¾ `seq_len=3000`, `window_size=32`, `head_dim=64`
   - è®¡ç®—é‡ï¼š`32 Ã— 3000 Ã— 64 = 6.14M` æ¬¡ä¹˜æ³•

2. **Softmax å½’ä¸€åŒ–**ï¼š
   ```python
   attn_weights = softmax(attn_weights)
   ```
   - è®¡ç®—é‡ï¼š`O(window_size Ã— seq_len)`
   - çº¦ `32 Ã— 3000 = 96K` æ¬¡æŒ‡æ•°è¿ç®—

3. **æ±‚å’Œèšåˆ**ï¼š
   ```python
   attn_weights_sum = attn_weights.sum(dim=-2)
   ```
   - è®¡ç®—é‡ï¼š`O(seq_len)`
   - çº¦ `3000` æ¬¡åŠ æ³•

4. **1D æ± åŒ–**ï¼š
   ```python
   attn_cache = avg_pool1d(attn_weights_sum, kernel_size=5)
   ```
   - è®¡ç®—é‡ï¼š`O(seq_len Ã— kernel_size)`
   - çº¦ `3000 Ã— 5 = 15K` æ¬¡è¿ç®—

5. **Top-K é€‰æ‹©**ï¼š
   ```python
   indices = attn_cache.topk(max_capacity - window_size)
   ```
   - è®¡ç®—é‡ï¼š`O(seq_len Ã— log(k))`
   - çº¦ `3000 Ã— log(256) â‰ˆ 24K` æ¬¡æ¯”è¾ƒ

6. **Gather æ“ä½œ**ï¼š
   ```python
   k_compress = key_states.gather(dim=2, index=indices)
   ```
   - è®¡ç®—é‡ï¼š`O(k Ã— head_dim)`
   - çº¦ `256 Ã— 64 = 16K` æ¬¡å†…å­˜è®¿é—®

**æ€»è®¡ç®—å¼€é”€ä¼°ç®—**ï¼š
- ä¸»è¦å¼€é”€ï¼šæ³¨æ„åŠ›æƒé‡è®¡ç®—ï¼ˆçº¦ 6M æ¬¡è¿ç®—ï¼‰
- æ¬¡è¦å¼€é”€ï¼šSoftmax + æ± åŒ– + Top-Kï¼ˆçº¦ 135K æ¬¡è¿ç®—ï¼‰
- **æ€»å¼€é”€ï¼šçº¦ 6.14M æ¬¡æµ®ç‚¹è¿ç®—**

### 1.4 è§¦å‘æ¡ä»¶

SnapKV åªåœ¨ä»¥ä¸‹æ¡ä»¶æ»¡è¶³æ—¶è§¦å‘å‹ç¼©ï¼š
```python
if q_len >= max_capacity_prompt:
    # æ‰§è¡Œå‹ç¼©
```

**å…³é”®ç‚¹**ï¼š
- åªåœ¨ **prompt phase**ï¼ˆprefillï¼‰è§¦å‘ï¼Œä¸åœ¨ decoding phase è§¦å‘
- å¦‚æœ prompt é•¿åº¦ < `max_capacity_prompt`ï¼Œä¸å‹ç¼©ï¼ˆæ— å¼€é”€ï¼‰
- å‹ç¼©æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸æ˜¯æ¯ä¸ª token éƒ½å‹ç¼©

## 2. Pythia-70M æ¨¡å‹ç‰¹æ€§

### 2.1 æ¨¡å‹è§„æ¨¡

| å‚æ•° | å€¼ |
|------|-----|
| å‚æ•°é‡ | 70M |
| å±‚æ•° | 6 |
| éšè—ç»´åº¦ | 512 |
| æ³¨æ„åŠ›å¤´æ•° | 8 |
| Head ç»´åº¦ | 64 |
| KV å¤´æ•° | 8 (GQA æœªå¯ç”¨) |

### 2.2 å•å±‚ KV Cache å¤§å°

å¯¹äºé•¿åº¦ä¸º `L` çš„åºåˆ—ï¼š
- Key Cache: `L Ã— 8 heads Ã— 64 dim = 512L` ä¸ªæµ®ç‚¹æ•°
- Value Cache: `L Ã— 8 heads Ã— 64 dim = 512L` ä¸ªæµ®ç‚¹æ•°
- å•å±‚æ€»å¤§å°ï¼š`1024L` ä¸ªæµ®ç‚¹æ•° = `4KB Ã— L`ï¼ˆfloat32ï¼‰

**6 å±‚æ€» KV Cache**ï¼š
- `6 Ã— 4KB Ã— L = 24KB Ã— L`
- å¯¹äº 3000 tokensï¼š`24KB Ã— 3000 = 72MB`

### 2.3 æ¨¡å‹æ¨ç†è®¡ç®—é‡

**å•æ¬¡å‰å‘ä¼ æ’­**ï¼ˆç”Ÿæˆ 1 ä¸ª tokenï¼‰ï¼š
- æ³¨æ„åŠ›è®¡ç®—ï¼š`O(L Ã— hidden_dim Ã— num_heads)`
- å¯¹äº Pythia-70Mï¼š`L Ã— 512 Ã— 8 = 4096L` æ¬¡è¿ç®—
- å¯¹äº 3000 tokensï¼š`4096 Ã— 3000 = 12.3M` æ¬¡è¿ç®—

**6 å±‚æ€»è®¡ç®—é‡**ï¼š`6 Ã— 12.3M = 73.8M` æ¬¡è¿ç®—

## 3. å¼€é”€å¯¹æ¯”åˆ†æ

### 3.1 SnapKV å‹ç¼©å¼€é”€ vs æ¨¡å‹æ¨ç†å¼€é”€

| æ“ä½œ | è®¡ç®—é‡ | å æ¯” |
|------|--------|------|
| **SnapKV å‹ç¼©**ï¼ˆå•å±‚ï¼‰ | 6.14M ops | 8.3% |
| **æ¨¡å‹æ¨ç†**ï¼ˆå•å±‚ï¼Œ3000 tokensï¼‰ | 12.3M ops | 16.7% |
| **æ¨¡å‹æ¨ç†**ï¼ˆ6 å±‚ï¼‰ | 73.8M ops | 100% |

**å…³é”®å‘ç°**ï¼š
- SnapKV å‹ç¼©å¼€é”€çº¦ä¸ºå•å±‚æ¨ç†çš„ **50%**
- å‹ç¼©å¼€é”€çº¦ä¸ºæ•´ä¸ªæ¨¡å‹æ¨ç†çš„ **8.3%**
- **å‹ç¼©æ˜¯ä¸€æ¬¡æ€§çš„**ï¼ˆåªåœ¨ prefill é˜¶æ®µï¼‰ï¼Œè€Œæ¨ç†æ˜¯æ¯ä¸ª token éƒ½è¦æ‰§è¡Œ

### 3.2 å†…å­˜èŠ‚çœ vs è®¡ç®—å¼€é”€

**åœºæ™¯ï¼š3000 tokens â†’ 512 tokens å‹ç¼©**

| æŒ‡æ ‡ | æ— å‹ç¼© | SnapKV å‹ç¼© | èŠ‚çœ |
|------|--------|-------------|------|
| KV Cache å¤§å° | 72MB | 12MB | **83%** |
| å‹ç¼©è®¡ç®—å¼€é”€ | 0 | 6.14M ops | - |
| åç»­æ¨ç†åŠ é€Ÿ | 73.8M ops/token | 12.6M ops/token | **83%** |

**æ”¶ç›Šåˆ†æ**ï¼š
- å‹ç¼©å¼€é”€ï¼š`6.14M ops`ï¼ˆä¸€æ¬¡æ€§ï¼‰
- æ¯ä¸ª token èŠ‚çœï¼š`73.8M - 12.6M = 61.2M ops`
- **å›æœ¬æ—¶é—´**ï¼š`6.14M / 61.2M â‰ˆ 0.1 tokens`

**ç»“è®º**ï¼šå³ä½¿å¯¹äºå°æ¨¡å‹ï¼ŒSnapKV çš„å‹ç¼©å¼€é”€ä¹Ÿ**è¿œå°äº**åç»­æ¨ç†çš„èŠ‚çœï¼Œåœ¨ç”Ÿæˆç¬¬ 1 ä¸ª token æ—¶å°±å·²ç»å›æœ¬ã€‚

### 3.3 å°æ¨¡å‹çš„ç‰¹æ®Šè€ƒè™‘

**æ½œåœ¨é—®é¢˜**ï¼š
1. **ç›¸å¯¹å¼€é”€æ›´å¤§**ï¼šå¯¹äºå¤§æ¨¡å‹ï¼ˆ7B+ï¼‰ï¼Œå‹ç¼©å¼€é”€å æ¯” < 1%ï¼Œä½†å¯¹äº 70M æ¨¡å‹ï¼Œå æ¯”çº¦ 8%
2. **ç²¾åº¦æŸå¤±**ï¼šå°æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›æœ‰é™ï¼Œå‹ç¼©å¯èƒ½é€ æˆæ›´å¤§çš„ç²¾åº¦æŸå¤±
3. **çª—å£å¤§å°é€‚é…**ï¼š`window_size=32-64` å¯èƒ½å¯¹å°æ¨¡å‹æ¥è¯´å¤ªå¤§

**ä¼˜åŒ–å»ºè®®**ï¼š
- å‡å° `window_size` åˆ° 16-32
- å‡å° `kernel_size` åˆ° 3-5
- é€‚å½“å¢å¤§ `max_capacity_prompt`ï¼ˆå¦‚ 512-1024ï¼‰

## 4. PG-19 æ•°æ®é›†é€‚ç”¨æ€§åˆ†æ

### 4.1 PG-19 æ•°æ®é›†ç‰¹æ€§

| ç‰¹æ€§ | å€¼ |
|------|-----|
| ç±»å‹ | é•¿æ–‡æœ¬å°è¯´ |
| å¹³å‡é•¿åº¦ | 50K-100K å­—ç¬¦ |
| Token æ•°ï¼ˆä¼°ç®—ï¼‰ | 10K-20K tokens |
| ç”¨é€” | é•¿ä¸Šä¸‹æ–‡ç†è§£æµ‹è¯• |

### 4.2 SnapKV åœ¨ PG-19 ä¸Šçš„ä¼˜åŠ¿

âœ… **éå¸¸é€‚åˆ**ï¼š
1. **è¶…é•¿ä¸Šä¸‹æ–‡**ï¼šPG-19 æ–‡æœ¬é•¿åº¦è¿œè¶…æ¨¡å‹çª—å£ï¼Œéå¸¸é€‚åˆæµ‹è¯•å‹ç¼©æ•ˆæœ
2. **ä¿¡æ¯å¯†åº¦**ï¼šå°è¯´æ–‡æœ¬ä¸­ï¼Œé‡è¦ä¿¡æ¯ï¼ˆäººç‰©ã€æƒ…èŠ‚ï¼‰ç›¸å¯¹é›†ä¸­ï¼Œå‹ç¼©æ•ˆæœå¥½
3. **è¯„ä¼°æŒ‡æ ‡**ï¼šå¯ä»¥æµ‹è¯• PPL å’Œç”Ÿæˆè´¨é‡

### 4.3 æ½œåœ¨æŒ‘æˆ˜

âš ï¸ **éœ€è¦æ³¨æ„**ï¼š
1. **ä¿¡æ¯ä¸¢å¤±**ï¼šå°è¯´ä¸­ç»†èŠ‚ä¿¡æ¯å¯èƒ½è¢«å‹ç¼©æ‰ï¼Œå½±å“ç”Ÿæˆè´¨é‡
2. **é•¿æœŸä¾èµ–**ï¼šå°è¯´æƒ…èŠ‚æœ‰é•¿æœŸä¾èµ–ï¼Œå‹ç¼©å¯èƒ½ç ´åè¿è´¯æ€§
3. **è¯„ä¼°éš¾åº¦**ï¼šéœ€è¦è®¾è®¡åˆé€‚çš„è¯„ä¼°ä»»åŠ¡ï¼ˆå¦‚ç»­å†™ã€é—®ç­”ï¼‰

### 4.4 å®éªŒè®¾è®¡å»ºè®®

**æ¨èé…ç½®**ï¼š
```python
window_size = 32          # å¯¹å°æ¨¡å‹ï¼Œ32 è¶³å¤Ÿ
max_capacity_prompt = 512 # å¹³è¡¡å†…å­˜å’Œæ€§èƒ½
kernel_size = 5          # æ ‡å‡†é…ç½®
pooling = 'avgpool'      # æ›´å¹³æ»‘
```

**è¯„ä¼°ä»»åŠ¡**ï¼š
1. **PPL è¯„ä¼°**ï¼šåœ¨å®Œæ•´æ–‡æœ¬ä¸Šè®¡ç®—å›°æƒ‘åº¦
2. **ç»­å†™ä»»åŠ¡**ï¼šç»™å®šå‰ N ä¸ª tokensï¼Œç”Ÿæˆåç»­æ–‡æœ¬
3. **é—®ç­”ä»»åŠ¡**ï¼šä»é•¿æ–‡æœ¬ä¸­æå–ä¿¡æ¯å›ç­”é—®é¢˜

## 5. å®éªŒéš¾åº¦è¯„ä¼°

### 5.1 å®ç°éš¾åº¦ï¼šâ­â­ (ç®€å•)

**ä¼˜åŠ¿**ï¼š
- SnapKV ä»£ç å·²ç»å®ç°ï¼Œåªéœ€é€‚é… Pythia-70M
- æ ¸å¿ƒç®—æ³•åœ¨ `snapkv_utils.py` ä¸­ï¼Œé€»è¾‘æ¸…æ™°
- å·²æœ‰ Llama/Mistral çš„å®ç°å‚è€ƒ

**éœ€è¦åšçš„å·¥ä½œ**ï¼š
1. ä¸º Pythia-70M åˆ›å»º `pythia_hijack.py`ï¼ˆå‚è€ƒ `llama_hijack_4_37.py`ï¼‰
2. åœ¨ `monkeypatch.py` ä¸­æ·»åŠ  `replace_pythia()` å‡½æ•°
3. æµ‹è¯•å’Œè°ƒå‚

**é¢„è®¡æ—¶é—´**ï¼š2-4 å°æ—¶

### 5.2 å®éªŒéš¾åº¦ï¼šâ­â­â­ (ä¸­ç­‰)

**éœ€è¦å®Œæˆ**ï¼š
1. **åŸºå‡†æµ‹è¯•**ï¼šæ— å‹ç¼© baseline çš„ PPL å’Œç”Ÿæˆé€Ÿåº¦
2. **å‚æ•°è°ƒä¼˜**ï¼šæµ‹è¯•ä¸åŒ `window_size`, `max_capacity_prompt`, `kernel_size`
3. **è¯„ä¼°æŒ‡æ ‡**ï¼š
   - PPLï¼ˆå›°æƒ‘åº¦ï¼‰
   - ç”Ÿæˆé€Ÿåº¦ï¼ˆTTFT, TPOTï¼‰
   - å†…å­˜å ç”¨
   - ç”Ÿæˆè´¨é‡ï¼ˆå¯é€‰ï¼‰

**é¢„è®¡æ—¶é—´**ï¼š1-2 å¤©

### 5.3 åˆ†æéš¾åº¦ï¼šâ­â­ (ç®€å•)

**å·²æœ‰å·¥å…·**ï¼š
- é¡¹ç›®å·²æœ‰ `evaluate.py` å’Œ `benchmark.py`
- å¯ä»¥å‚è€ƒç°æœ‰çš„ KnormPress å®éªŒç»“æœ

**éœ€è¦åˆ†æ**ï¼š
1. å‹ç¼©å¼€é”€ vs æ¨ç†åŠ é€Ÿçš„æƒè¡¡
2. ä¸åŒå‚æ•°é…ç½®çš„æ•ˆæœå¯¹æ¯”
3. ä¸ KnormPress æ–¹æ³•çš„å¯¹æ¯”

## 6. é¢„æœŸæ•ˆæœ

### 6.1 æ€§èƒ½é¢„æœŸ

åŸºäº SnapKV è®ºæ–‡å’Œ KnormPress å®éªŒç»“æœï¼š

| æŒ‡æ ‡ | Baseline | SnapKV | å˜åŒ– |
|------|----------|--------|------|
| **PPL** | 47.04 | 49-52 | +4-10% |
| **å†…å­˜å ç”¨** | 72MB (3000 tokens) | 12MB (512 tokens) | **-83%** |
| **ç”Ÿæˆé€Ÿåº¦** | åŸºå‡† | 1.5-2x | **+50-100%** |
| **å‹ç¼©å¼€é”€** | 0 | 6.14M ops | +8.3% |

### 6.2 ä¸å°æ¨¡å‹çš„é€‚é…æ€§

**ä¹è§‚é¢„æœŸ**ï¼š
- âœ… å†…å­˜èŠ‚çœæ˜¾è‘—ï¼ˆ83%+ï¼‰
- âœ… ç”Ÿæˆé€Ÿåº¦æå‡æ˜æ˜¾ï¼ˆ50-100%ï¼‰
- âš ï¸ PPL å¯èƒ½å¢åŠ  5-10%ï¼ˆå¯æ¥å—ï¼‰

**ä¿å®ˆé¢„æœŸ**ï¼š
- âœ… å†…å­˜èŠ‚çœ 70-80%
- âœ… ç”Ÿæˆé€Ÿåº¦æå‡ 30-50%
- âš ï¸ PPL å¢åŠ  10-15%ï¼ˆéœ€è¦è°ƒå‚ä¼˜åŒ–ï¼‰

### 6.3 ä¸ KnormPress å¯¹æ¯”

| æ–¹æ³• | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|------|------|
| **KnormPress** | ç®€å•ï¼Œå¼€é”€å° | é™æ€é€‰æ‹©ï¼Œå¯èƒ½ä¸¢å¤±é‡è¦ä¿¡æ¯ |
| **SnapKV** | åŠ¨æ€é€‰æ‹©ï¼ŒåŸºäºæ³¨æ„åŠ› | è®¡ç®—å¼€é”€ç¨å¤§ï¼Œéœ€è¦è°ƒå‚ |

**é¢„æœŸ**ï¼šSnapKV åœ¨ç”Ÿæˆè´¨é‡ä¸Šå¯èƒ½ç•¥ä¼˜äº KnormPressï¼Œä½†å¼€é”€ç¨å¤§ã€‚

## 7. ç»“è®ºä¸å»ºè®®

### 7.1 å¯è¡Œæ€§ç»“è®º

âœ… **é«˜åº¦å¯è¡Œ**ï¼š
1. **è®¡ç®—å¼€é”€å¯æ¥å—**ï¼šå‹ç¼©å¼€é”€ï¼ˆ8.3%ï¼‰è¿œå°äºæ¨ç†èŠ‚çœï¼ˆ83%ï¼‰
2. **å®ç°ç®€å•**ï¼šä»£ç å·²å®ç°ï¼Œåªéœ€é€‚é…
3. **æ•ˆæœæ˜æ˜¾**ï¼šå†…å­˜å’Œé€Ÿåº¦éƒ½æœ‰æ˜¾è‘—æå‡

### 7.2 æ¨èå®éªŒæ–¹æ¡ˆ

**é˜¶æ®µ 1ï¼šå¿«é€ŸéªŒè¯ï¼ˆ1-2 å¤©ï¼‰**
```python
# åŸºç¡€é…ç½®
window_size = 32
max_capacity_prompt = 512
kernel_size = 5
pooling = 'avgpool'

# æµ‹è¯•æŒ‡æ ‡
- PPL on PG-19
- ç”Ÿæˆé€Ÿåº¦ï¼ˆTTFT, TPOTï¼‰
- å†…å­˜å ç”¨
```

**é˜¶æ®µ 2ï¼šå‚æ•°è°ƒä¼˜ï¼ˆ1-2 å¤©ï¼‰**
```python
# å‚æ•°ç½‘æ ¼æœç´¢
window_size: [16, 32, 64]
max_capacity_prompt: [256, 512, 1024]
kernel_size: [3, 5, 7]
pooling: ['avgpool', 'maxpool']
```

**é˜¶æ®µ 3ï¼šå¯¹æ¯”åˆ†æï¼ˆ1 å¤©ï¼‰**
- ä¸ KnormPress å¯¹æ¯”
- ä¸ baseline å¯¹æ¯”
- å¼€é”€åˆ†æ

### 7.3 é£é™©ä¸ç¼“è§£

**é£é™© 1**ï¼šå°æ¨¡å‹ç²¾åº¦æŸå¤±è¾ƒå¤§
- **ç¼“è§£**ï¼šå¢å¤§ `max_capacity_prompt`ï¼Œå‡å°å‹ç¼©æ¯”

**é£é™© 2**ï¼šå‹ç¼©å¼€é”€å æ¯”è¿‡é«˜
- **ç¼“è§£**ï¼šå‡å° `window_size`ï¼Œä¼˜åŒ–å®ç°

**é£é™© 3**ï¼šPG-19 è¯„ä¼°ä»»åŠ¡è®¾è®¡å›°éš¾
- **ç¼“è§£**ï¼šä½¿ç”¨æ ‡å‡† PPL è¯„ä¼°ï¼Œå‚è€ƒç°æœ‰å®ç°

### 7.4 æœ€ç»ˆå»ºè®®

**å¼ºçƒˆæ¨èè¿›è¡Œå®éªŒ**ï¼Œç†ç”±ï¼š
1. âœ… å®ç°æˆæœ¬ä½ï¼ˆ2-4 å°æ—¶ï¼‰
2. âœ… é¢„æœŸæ”¶ç›Šé«˜ï¼ˆå†…å­˜ -83%ï¼Œé€Ÿåº¦ +50%ï¼‰
3. âœ… é£é™©å¯æ§ï¼ˆPPL å¢åŠ å¯æ¥å—ï¼‰
4. âœ… æœ‰å‚è€ƒå®ç°å’Œè®ºæ–‡æ”¯æŒ

**å®éªŒä¼˜å…ˆçº§**ï¼š
1. ğŸ”¥ **é«˜ä¼˜å…ˆçº§**ï¼šåŸºç¡€å®ç°å’Œå¿«é€ŸéªŒè¯
2. â­ **ä¸­ä¼˜å…ˆçº§**ï¼šå‚æ•°è°ƒä¼˜å’Œæ•ˆæœåˆ†æ
3. ğŸ’¡ **ä½ä¼˜å…ˆçº§**ï¼šä¸ KnormPress è¯¦ç»†å¯¹æ¯”

---

## é™„å½•ï¼šä»£ç å®ç°å‚è€ƒ

### A.1 åˆ›å»º Pythia é€‚é…

å‚è€ƒ `llama_hijack_4_37.py`ï¼Œåˆ›å»º `pythia_hijack.py`ï¼š

```python
from snapkv.monkeypatch.snapkv_utils import init_snapkv
from transformers.models.gpt_neox.modeling_gpt_neox import (
    GPTNeoXFlashAttention2,
    GPTNeoXForCausalLM
)

def pythia_flash_attn2_forward(self, ...):
    init_snapkv(self)
    # ç±»ä¼¼ llama_flash_attn2_forward çš„å®ç°
    # æ³¨æ„ï¼šPythia åŸºäº GPT-NeoXï¼Œattention å®ç°å¯èƒ½ä¸åŒ
    ...
```

### A.2 å…³é”®å‚æ•°é…ç½®

```python
# é’ˆå¯¹ Pythia-70M çš„æ¨èé…ç½®
config.window_size = 32
config.max_capacity_prompt = 512
config.kernel_size = 5
config.pooling = 'avgpool'
```

### A.3 è¯„ä¼°è„šæœ¬

å¯ä»¥å‚è€ƒç°æœ‰çš„ `benchmark_knormpress.py`ï¼Œåˆ›å»º `benchmark_snapkv.py`ï¼š

```python
from snapkv.monkeypatch.monkeypatch import replace_pythia

# å¯ç”¨ SnapKV
replace_pythia()

# åŠ è½½æ¨¡å‹å’Œæ•°æ®é›†
model, tokenizer = load_model_and_tokenizer("EleutherAI/pythia-70m-deduped")
samples = load_pg19_samples(num_samples=5)

# è¿è¡ŒåŸºå‡†æµ‹è¯•
results = benchmark_snapkv(model, tokenizer, samples, ...)
```

